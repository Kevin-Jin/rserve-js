(function(a){if(a.WebSocket===undefined)if(a.MozWebSocket)a.WebSocket=a.MozWebSocket;else throw"WebSocket support not found"})(this),function(a){var b;(function(){var a=new ArrayBuffer(4),c=new Uint8Array(a),d=new Uint32Array(a);c[0]=1;if(d[0]===1)b=!0;else if(d[0]===16777216)b=!1;else throw"we're bizarro endian, refusing to continue"})();if(!a.DataView){var c=["Int32","Int16","Uint32","Uint16","Float32","Float64"],d=["setInt32","setInt16","setUint32","setUint16","setFloat32","setFloat64"],e=["getInt32","getInt16","getUint32","getUint16","getFloat32","getFloat64"];console.log("polyfilling DataView");var f={};for(var g=0;g<c.length;++g){var h=this[c[g]+"Array"],i=h.BYTES_PER_ELEMENT,j=new ArrayBuffer(i),k=new h(j),l=new Uint8Array(j);f[c[g]]=function(a,b){return function(c,d,e,f){a[0]=f;for(var g=0;g<d;++g)c[e+g]=b[g]}}(k,l)}function m(a,c,d){this.buffer=a,this.byteOffset=_.isUndefined(c)?0:c,this.byteLength=_.isUndefined(d)?a.byteLength:d,this.view=new jDataView(a,c,d,b),this.byte_array=new Uint8Array(a)}var n={};m.prototype=n;for(g=0;g<c.length;++g){var o="get"+c[g];n[o]=function(a){return function(b){return this.view[a](b)}}(o);var p="set"+c[g],i=this[c[g]+"Array"].BYTES_PER_ELEMENT;n[p]=function(a,b){return function(c,d){console.log(b),console.log(f),f[b](this.byte_array,a,c,d)}}(i,c[g])}n.setUint8=function(a,b){this.byte_array[a]=b},n.setInt8=function(a,b){b<0&&(b+=256),this.byte_array[a]=b},n.getInt8=function(a){return this.view.GetInt8(a)},n.getUint8=function(a){return this.byte_array[a]},a.DataView=m}}(this),function(a){var b;(function(){var a=new ArrayBuffer(4),c=new Uint8Array(a),d=new Uint32Array(a);c[0]=1;if(d[0]===1)b=!0;else if(d[0]===16777216)b=!1;else throw"we're bizarro endian, refusing to continue"})(),a.EndianAwareDataView=function(){function g(a,b,c){b===undefined?this.view=new DataView(a):this.view=new DataView(a,b,c)}var a={setInt8:function(a,b){return this.view.setInt8(a,b)},setUint8:function(a,b){return this.view.setUint8(a,b)},getInt8:function(a){return this.view.getInt8(a)},getUint8:function(a){return this.view.getUint8(a)}},c=["setInt32","setInt16","setUint32","setUint16","setFloat32","setFloat64"],d=["getInt32","getInt16","getUint32","getUint16","getFloat32","getFloat64"];for(var e=0;e<c.length;++e){var f=c[e];a[f]=function(a){return function(c,d){return this.view[a](c,d,b)}}(f)}for(e=0;e<d.length;++e){var f=d[e];a[f]=function(a){return function(c){return this.view[a](c,b)}}(f)}return g.prototype=a,g}(),a.my_ArrayBufferView=function(a,b,c){return b=_.isUndefined(b)?0:b,c=_.isUndefined(c)?a.byteLength:c,{buffer:a,offset:b,length:c,make:function(a,b,c){b=_.isUndefined(b)?0:b,c=_.isUndefined(c)?this.length:c;var d=a.BYTES_PER_ELEMENT||1,e=c/d;if((this.offset+b)%d!=0){var f=new DataView(this.buffer,this.offset+b,c),g=new ArrayBuffer(c),h=new DataView(g);for(var i=0;i<c;++i)h.setUint8(i,f.getUint8(i));return new a(g)}return new a(this.buffer,this.offset+b,e)},view:function(a,b){return my_ArrayBufferView(this.buffer,this.offset+a,b)}}}}(this),function(){function a(a,b){this.name="RserveError",this.message=a,this.status_code=b}function c(c){function f(a,b){return function(c,d){return[a.call(i,c,d),b||d]}}function g(a,b){return function(c,d){var e=a.call(i,c,d),f=b(e[0])(c,d-e[1]);return[f[0],e[1]+f[1]]}}function h(a){return function(b,c){var d=[],e=c;while(c>0){var f=a.call(i,b,c);d.push(f[0]),c-=f[1]}return[d,e]}}function j(a,b){return g(a,function(a){return f(function(c,d){return b(a,c)},0)})}function k(a,b){return f(function(c,d){return b(a.call(i,d),c)})}var d={},e,i={offset:0,data_view:c.make(EndianAwareDataView),msg:c,read_int:function(){var a=this.offset;return this.offset+=4,this.data_view.getInt32(a)},read_string:function(a){var b="";while(a--){var c=this.data_view.getInt8(this.offset++);c&&(b+=String.fromCharCode(c))}return b},read_stream:function(a){var b=this.offset;return this.offset+=a,this.msg.view(b,a)},read_int_vector:function(a){var b=this.offset;return this.offset+=a,this.msg.make(Int32Array,b,a)},read_double_vector:function(a){var b=this.offset;return this.offset+=a,this.msg.make(Float64Array,b,a)},read_null:f(function(a,b){return Robj.null(a)}),read_string_array:function(a,b){var c=this.read_stream(b).make(Uint8Array),d=[],e="";for(var f=0;f<c.length;++f)c[f]===0?(d.push(e),e=""):e+=String.fromCharCode(c[f]);return[Robj.string_array(d,a),b]},read_bool_array:function(a,b){var c=this.read_int(),d=this.read_stream(b-4),e=d.make(Uint8Array),f=[];for(var g=0;g<c;++g)f[g]=!!e[g];return[Robj.bool_array(f,a),b]},read_sexp:function(){var c=this.read_int(),e=b.par_parse(c),f=e[0],g=e[1],h=4,i=undefined;if(f&b.XT_HAS_ATTR){f&=~b.XT_HAS_ATTR;var j=this.read_sexp();i=j[0],h+=j[1],g-=j[1]}if(d[f]===undefined)throw new a("Unimplemented "+f,-1);var k=d[f].call(this,i,g);return[k[0],h+k[1]]}};return i.read_clos=g(i.read_sexp,function(a){return g(i.read_sexp,function(b){return f(function(c,d){return Robj.clos(a,b,c)},0)})}),i.read_list=h(i.read_sexp),i.read_list_tag=g(i.read_list,function(b){return f(function(c,d){var e={};for(var f=0;f<b.length;f+=2){var g=b[f],h=b[f+1];if(h.type!=="symbol")throw new a("Unexpected type "+h.type+" as tag for tagged_list",-1);e[h.value]=g}return Robj.tagged_list(e,c)},0)}),i.read_vector=j(i.read_list,Robj.vector),i.read_list_no_tag=j(i.read_list,Robj.list),i.read_lang_no_tag=j(i.read_list,Robj.lang),i.read_vector_exp=j(i.read_list,Robj.vector_exp),i.read_symname=k(i.read_string,Robj.symbol),i.read_int_array=k(i.read_int_vector,Robj.int_array),i.read_double_array=k(i.read_double_vector,Robj.double_array),d[b.XT_NULL]=i.read_null,d[b.XT_VECTOR]=i.read_vector,d[b.XT_CLOS]=i.read_clos,d[b.XT_SYMNAME]=i.read_symname,d[b.XT_LIST_NOTAG]=i.read_list_no_tag,d[b.XT_LIST_TAG]=i.read_list_tag,d[b.XT_LANG_NOTAG]=i.read_lang_no_tag,d[b.XT_VECTOR_EXP]=i.read_vector_exp,d[b.XT_ARRAY_INT]=i.read_int_array,d[b.XT_ARRAY_DOUBLE]=i.read_double_array,d[b.XT_ARRAY_STR]=i.read_string_array,d[b.XT_ARRAY_BOOL]=i.read_bool_array,i}function d(d){var f=new Int32Array(d,0,4);if(f[0]!==b.RESP_OK&&f[0]!==b.OOB_SEND){var g=f[0]>>24;throw new a("ERROR FROM R SERVER: "+(b.status_codes[g]||g)+" "+f[0]+" "+f[1]+" "+f[2]+" "+f[3]+" "+d.byteLength+" "+d,g)}var h=my_ArrayBufferView(d,16,d.byteLength-16);if(h.length===0)return null;var i=e(c(h));return[i,f[0]]}function e(c){var d=c.read_int(),e=b.par_parse(d),f=e[0],g=e[1];if(f===b.DT_INT)return{type:"int",value:c.read_int()};if(f===b.DT_STRING)return{type:"string",value:c.read_string(g)};if(f===b.DT_BYTESTREAM)return{type:"stream",value:c.read_stream(g)};if(f===b.DT_SEXP){e=c.read_sexp();var h=e[0],i=e[1];return{type:"sexp",value:h}}throw new a("Bad type for parse? "+f+" "+g,-1)}function f(a,b){return function(c,d){function e(){this.type=a,this.value=c,this.attributes=d}return e.prototype=b||{html_element:function(){return $("<div class='obj'></div>").append($("<div class='key'></div>").html(a))}},new e}}function g(a){function b(){var b=$("<div class='obj'></div>"),c=$("<div class='string-value'></div>"),d=this.value,e,f=this;a=a||function(a){return a};var g;this.attributes&&this.attributes.value.names?g=function(b){return f.attributes.value.names.value[b]+": "+a(String(d[b]))}:this.attributes&&this.attributes.value.levels?g=function(a){return f.attributes.value.levels.value[d[a]-1]}:g=function(b){return a(String(d[b]))};if(d.length===0)e="[]";else if(d.length===1)e=g(0);else if(d.length<=10){e="["+g(0);for(var h=1;h<d.length;++h)e=e+", "+g(h);e+="]"}else{e="["+g(0);for(var h=1;h<5;++h)e=e+", "+g(h);e+=", ... ";for(h=d.length-5;h<d.length;++h)e=e+", "+g(h);e+="]"}return c.html(e),b.append(c),b}function c(){var a=document.createElement("table"),b=document.createElement("tr");a.appendChild(b);var c=this.attributes.value.dim.value,d=this.value,e=this;return d3.select(b).selectAll("td").data(_.range(c[1]+1)).enter().append("td").text(function(a){return a===0?"":"[,"+a+"]"}),d3.select(a).selectAll("tr-data").data(_.range(c[0])).enter().append("tr").selectAll("td").data(function(a){return _.map(_.range(c[1]+1),function(b){return[a,b]})}).enter().append("td").text(function(a){var b=a[0],f=a[1];if(f===0)return"["+(b+1)+",]";var g=d[(f-1)*c[0]+b];return e.attributes&&e.attributes.value.levels?e.attributes.value.levels.value[g-1]:g}),a}return function(){return this.attributes&&this.attributes.value.dim?c.call(this):b.call(this)}}a.prototype=Object.create(Error),a.prototype.constructor=a;var b={PAR_TYPE:function(a){return a&255},PAR_LEN:function(a){return a>>8},PAR_LENGTH:function(a){return a>>8},par_parse:function(a){return[b.PAR_TYPE(a),b.PAR_LEN(a)]},SET_PAR:function(a,b){return(b&16777215)<<8|a&255},CMD_STAT:function(a){return a>>24&127},SET_STAT:function(a,b){return a|(b&127)<<24},CMD_RESP:65536,RESP_OK:65537,RESP_ERR:65538,OOB_SEND:200704,ERR_auth_failed:65,ERR_conn_broken:66,ERR_inv_cmd:67,ERR_inv_par:68,ERR_Rerror:69,ERR_IOerror:70,ERR_notOpen:71,ERR_accessDenied:72,ERR_unsupportedCmd:73,ERR_unknownCmd:74,ERR_data_overflow:75,ERR_object_too_big:76,ERR_out_of_mem:77,ERR_ctrl_closed:78,ERR_session_busy:80,ERR_detach_failed:81,CMD_long:1,CMD_voidEval:2,CMD_eval:3,CMD_shutdown:4,CMD_openFile:16,CMD_createFile:17,CMD_closeFile:18,CMD_readFile:19,CMD_writeFile:20,CMD_removeFile:21,CMD_setSEXP:32,CMD_assignSEXP:129,CMD_detachSession:48,CMD_detachedVoidEval:49,CMD_attachSession:50,CMD_ctrl:64,CMD_ctrlEval:66,CMD_ctrlSource:69,CMD_ctrlShutdown:68,CMD_setBufferSize:129,CMD_setEncoding:130,CMD_SPECIAL_MASK:240,CMD_serEval:245,CMD_serAssign:246,CMD_serEEval:247,DT_INT:1,DT_CHAR:2,DT_DOUBLE:3,DT_STRING:4,DT_BYTESTREAM:5,DT_SEXP:10,DT_ARRAY:11,DT_LARGE:64,XT_NULL:0,XT_INT:1,XT_DOUBLE:2,XT_STR:3,XT_LANG:4,XT_SYM:5,XT_BOOL:6,XT_S4:7,XT_VECTOR:16,XT_LIST:17,XT_CLOS:18,XT_SYMNAME:19,XT_LIST_NOTAG:20,XT_LIST_TAG:21,XT_LANG_NOTAG:22,XT_LANG_TAG:23,XT_VECTOR_EXP:26,XT_VECTOR_STR:27,XT_ARRAY_INT:32,XT_ARRAY_DOUBLE:33,XT_ARRAY_STR:34,XT_ARRAY_BOOL_UA:35,XT_ARRAY_BOOL:36,XT_RAW:37,XT_ARRAY_CPLX:38,XT_UNKNOWN:48,XT_LARGE:64,XT_HAS_ATTR:128,BOOL_TRUE:1,BOOL_FALSE:0,BOOL_NA:2,GET_XT:function(a){return a&63},GET_DT:function(a){return a&63},HAS_ATTR:function(a){return(a&b.XT_HAS_ATTR)>0},IS_LARGE:function(a){return(a&b.XT_LARGE)>0},itop:function(a){return a},ptoi:function(a){return a},dtop:function(a){return a},ptod:function(a){return a},fixdcpy:function(){throw new a("unimplemented",-1)},status_codes:{65:"ERR_auth_failed",66:"ERR_conn_broken",67:"ERR_inv_cmd",68:"ERR_inv_par",69:"ERR_Rerror",70:"ERR_IOerror",71:"ERR_notOpen",72:"ERR_accessDenied",73:"ERR_unsupportedCmd",74:"ERR_unknownCmd",75:"ERR_data_overflow",76:"ERR_object_too_big",77:"ERR_out_of_mem",78:"ERR_ctrl_closed",80:"ERR_session_busy",81:"ERR_detach_failed"}};Robj={"null":function(a){return{type:"null",value:null,attributes:a,html_element:function(){return $("<div class='obj'><div class='key'>null</div></div>")}}},clos:function(a,b,c){return{type:"clos",value:{formals:a,body:b},attributes:c,html_element:function(){var a=$("<div class='obj'></div>"),b=$("<div></div>");return b.append($("<div class='key'>formals:</div>")),b.append(this.value.formals.html_element()),a.append(b),b=$("<div></div>"),b.append($("<div class='key'>body:</div>")),b.append(this.value.body.html_element()),a.append(b),a}}},vector:f("vector",{html_element:function(){var a=$("<div class='obj'></div>");if(!this.attributes)for(var b=0;b<this.value.length;++b)a.append(this.value[b].html_element());else{var c=_.map(this.value,function(a){return a.value.length}),d=this.attributes.value.names.value;if(_.all(c,function(a){return a===c[0]})){var e=document.createElement("table"),f=document.createElement("tr"),g=this.value;e.appendChild(f),d3.select(f).selectAll("th").data(_.range(c.length)).enter().append("th").text(function(a){return d[a]});var h;c[0]<11?h=_.range(c[0]):(h=[0,1,2,3,4,5],h.push.apply(h,_.range(c[0]-5,c[0]))),d3.select(e).selectAll("tr-data").data(h).enter().append("tr").selectAll("td").data(function(a){return _.map(_.range(c.length),function(b){return[a,b]})}).enter().append("td").text(function(a,b){var d=a[0],e=a[1];if(c[0]>=11&&d===5)return"...";var f=g[e].value[d];return g[e].attributes?g[e].attributes.value.levels.value[f-1]:f}),a.append(e)}else{var i=$("<div></div>");for(var b=0;b<this.value.length;++b)i.append($("<span class='key'></span>").append(d[b]+": ")),i.append(this.value[b].html_element());a.append(i)}}return a}}),symbol:f("symbol"),list:f("list"),lang:f("lang"),tagged_list:f("tagged_list"),tagged_lang:f("tagged_lang"),vector_exp:f("vector_exp"),int_array:f("int_array",{html_element:g()}),double_array:f("double_array",{html_element:g()}),string_array:f("string_array",{html_element:g(function(a){var b,c,d=a.length,e='"';for(c=0;c<d;c+=1){b=a.charAt(c);if(b>=" "){if(b==="\\"||b==='"')e+="\\";e+=b}else switch(b){case"\b":e+="\\b";break;case"\f":e+="\\f";break;case"\n":e+="\\n";break;case"\r":e+="\\r";break;case"\t":e+="\\t";break;default:b=b.charCodeAt(),e+="\\u00"+Math.floor(b/16).toString(16)+(b%16).toString(16)}}return e+'"'})}),bool_array:f("bool_array",{html_element:g()})},Rserve={create:function(c){function m(a){a=a.data,a.substr(0,4)!=="Rsrv"?h("server is not an RServe instance",-1):a.substr(4,4)!=="0103"?h("sorry, rserve only speaks the 0103 version of the R server protocol",-1):a.substr(8,4)!=="QAP1"?h("sorry, rserve only speaks QAP1",-1):(i=!0,c.login&&k.login(c.login),k.running=!0,f&&f.call(k))}var e=c.host,f=c.on_connect,g=new WebSocket(e),h=c.on_error||function(b){throw new a(b,-1)};g.binaryType="arraybuffer";var i=!1,j=[],k,l=0;return g.onclose=function(a){k.running=!1,c.on_close&&c.on_close(a)},g.onmessage=function(e){if(!i){m(e);return}if(typeof e.data=="string")c.on_raw_string&&c.on_raw_string(e.data);else{var f;try{f=d(e.data)}catch(g){h(g.message,g.status_code);return}if(f===null)return;var k=f[1];f=f[0];switch(k){case b.RESP_OK:var l=j.shift();l(f);break;case b.OOB_SEND:c.on_data&&c.on_data(f);break;default:throw new a("Internal Error, parse returned unexpected type "+k,-1)}}},k={close:function(){g.close()},login:function(a){var b=a,c=new ArrayBuffer(b.length+21),d=new EndianAwareDataView(c);d.setInt32(0,1),d.setInt32(4,5+b.length),d.setInt32(8,0),d.setInt32(12,0),d.setInt32(16,4+(1+b.length<<8));for(var e=0;e<b.length;++e)d.setUint8(20+e,b.charCodeAt(e));d.setUint8(c.byteLength-1,0),g.send(c)},eval:function(a,b){b=b||function(){},j.push(b);var c=new ArrayBuffer(a.length+21),d=new EndianAwareDataView(c);d.setInt32(0,3),d.setInt32(4,5+a.length),d.setInt32(8,0),d.setInt32(12,0),d.setInt32(16,4+(1+a.length<<8));for(var e=0;e<a.length;++e)d.setUint8(20+e,a.charCodeAt(e));d.setUint8(c.byteLength-1,0),g.send(c)}},k}}}();